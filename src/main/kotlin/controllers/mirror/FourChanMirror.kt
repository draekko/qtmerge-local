package controllers.mirror

import QTMirror
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import extensions.iterate
import extensions.readBytesDelayed
import models.events.Event
import models.events.PostEvent
import models.mirror.FourChanPost
import models.mirror.FourChanThread
import utils.HTML.Companion.cleanHTMLText
import java.io.File
import java.io.FileNotFoundException
import java.io.IOException
import java.net.URL
import java.time.Instant
import java.time.ZonedDateTime

class FourChanMirror(
        mirrorDirectory : String,
        board : String,
        val startTime : ZonedDateTime = ZonedDateTime.ofInstant(Instant.EPOCH, QTMirror.ZONEID),
        val stopTime : ZonedDateTime = ZonedDateTime.ofInstant(Instant.now(), QTMirror.ZONEID)
) : Mirror(mirrorDirectory, board, Source.FourChan, "anonsw") {
    val mirrorRoot = mirrorDirectory + File.separator + dataset + File.separator + "4chan"
    val boardRoot = mirrorRoot + File.separator + "boards" + File.separator + board
    var filesRoot = mirrorRoot + File.separator + "files"
    var threads : MutableList<String> = arrayListOf()
    val updatedThreads : MutableList<String> = arrayListOf()

    companion object {
        val ANONUIDS = mapOf(
                Pair("pol", listOf(
                        "BQ7V3bcW", "P3Lk4PKG", "Eka5Om1K", "grTMpzrL", "pGukiFmX", "zGyR4tyi", "KC17sSpZ",
                        "WBXFv1gI", "GVUvg1M7", "s4Iv8TW8", "AZhJ37bn", "v3eCc2tY", "cS8cMPVQ", "L8quGPI9",
                        "hHkrVD7x", "FAkr+Yka", "KKIreCTB", "NOjYqEdl", "Dx5TPc5d", "8GzG+UJ9"
                ))
        )
        val EXCEPTIONS = mapOf(
                Pair("pol", BoardExceptions(
                        orphanThreads = listOf(
                                // TODO: threads between Q first post and CBTS #0
                                "146981635", "147075091", "147075091", "147146601", "147433975",
                                // I Hope Trump Isn't Being Baited (CBTS #0)
                                "147505376",
                                // CBTS # (note, there are a good number of other duped breads that were left out because they didn't appear to have any significant posts other than OPs)
                                // 1          2            3            4            5            6            7            8            9            10
                                "147547939", "147591553", "147647514", "147663862", "147675249", "147688425", "147698233", "147707251", "147713026", "147718733",
                                // 11         12           13           14           15           16           17           18           19           20
                                "147723497", "147729217", "147733722", "147738057", "147742686", "147749054", "147753965", "147757745", "147761953", "147767118",
                                // 21         21           22           23           24           25           26           26           27           28             21, 26 duped
                                "147771723", "147772712", "147777245", "147789188", "147795123", "147799793", "147806651", "147805699", "147812859", "147820861",
                                // 29         30           31           32           33           34           35           37           38           39             36 skipped
                                "147826947", "147832860", "147838306", "147842691", "147847925", "147852827", "147856568", "147866525", "147872432", "147879516",
                                // 40         41           42           43           44           45           46           47           48           49
                                "148068340", "147895174", "147904303", "147917391", "147930240", "147948972", "147960491", "147970787", "147978093", "147985682",
                                // 50         51           52           53           54           55           56           57           58           59
                                "147992733", "147998236", "148005080", "148011686", "148019103", "148034203", "148041988", "148046219", "148054524", "148065127",
                                // 60         61           62           63           64           65           66           67           68           69
                                "148068340", "148076333", "148083646", "148090751", "148097793", "148106618", "148114811", "148123455", "148136485", "148146734",
                                // 70         71           72           73           74           75           76           77           78           79
                                "148154538", "148160366", "148176974", "148173688", "148176974", "148181225", "148186002", "148190849", "148196063", "148201347",
                                // 80         81           82           83a          83b          85           86           87           88           89
                                "148204451", "148213001", "148221475", "148229746", "148234777", "148240370", "148246271", "148251038", "148256302", "148261237",
                                // 90         91           92           93           94           95           96           97           98           99
                                "148266772", "148271269", "148276170", "148282598", "148286642", "148291219", "148295427", "148300758", "148304340", "148309541",
                                // 100        101          102          103          104          105          106          107          108          109
                                "148314494", "148318583", "148323702", "148329038", "148334244", "148338867", "148343407", "148348137", "148352970", "148358227",
                                // 110        111          112          113          114          115          116          117          118          119
                                "148363139", "148368571", "148372544", "148374664", "148379005", "148385050", "148391848", "148400827", "148406389", "148411843",
                                // 120        121          122          123          124          125          126          127          128          129
                                "148417958", "148423421", "148428807", "148434539", "148441575", "148446747", "148451796", "148456641", "148462224", "148468783",
                                // 130        131          132          133          134          135          136          137          138          139
                                "148473607", "148477757", "148480988", "148483728", "148487621", "148491265", "148495511", "148500367", "148504846", "148508231",
                                // 140        140          141          142          143          144          144          145          146          147           140, 144 duped
                                "148514027", "148514042", "148519163", "148524767", "148530052", "148533912", "148534042", "148540136", "148544337", "148548434",
                                // 148        149          150          151          152          153          154          155          156          157
                                "148553325", "148557043", "148562031", "148566783", "148571707", "148577324", "148582957", "148588118", "148592051", "148597247",
                                // 158        159          160          160          161          162          163          164          165          166           160 duped
                                "148602052", "148607324", "148614976", "148614855", "148619018", "148623820", "148631152", "148634970", "148640302", "148644609",
                                // 167        168          169          170          171          172          173          175          176          177           174 skipped
                                "148649073", "148653970", "148657729", "148662316", "148667995", "148673072", "148678910", "148687223", "148694240", "148699303",
                                // 178        179          180          181          182          183          184          185          186          187
                                "148704294", "148710397", "148716484", "148721961", "148727354", "148734501", "148740228", "148746105", "148752687", "148757076",
                                // 188        189          190          191          192          193          194          195          196          197
                                "148764040", "148767870", "148773150", "148777785", "148782359", "148786272", "148790098", "148793723", "148797641", "148802424",
                                // 198        199          200          200          201          202          203          204          205          206           200 duped
                                "148807166", "148813205", "148817572", "148817356", "148821018", "148826347", "148831474", "148836289", "148840998", "148846144",
                                // 207        208          209          210          211          212          213          214
                                "148850984", "148855781", "148861698", "148866159", "148871896", "148875999", "148879274", "148882980",

                                // Six 215 boards were created, 148887237 won
                                // 215        215          215          215          215          215
                                "148886327", "148887237", "148887502", "148886658", "148886685", "148886838",

                                // 216        217          218          219          220          221          222          223          224          225
                                "148890312", "148894295", "148899705", "148904556", "148909203", "148913769", "148918874", "148924251", "148929892", "148934599",
                                // 226        227          228          229          230          231          232          233          234          235
                                "148939441", "148944212", "148948550", "148957446", "148962670", "148967622", "148972537", "148978657", "148984584", "148989485",
                                // 236        237          238          239          240          241          242          243          244          245
                                "148995481", "149000955", "149005831", "149010837", "149016980", "149023286", "149031238", "149036109", "149042148", "149049640",
                                // 246        247          248          249          250          251          252          253          What         254           'What' bread mislabed
                                "149052035", "149061733", "149061971", "149066113", "149068500", "149071870", "149076528", "149080733", "149085006", "149085217",
                                // 255        256          257          258          258          259          260          261          262          263           258 duped
                                "149089184", "149094656", "149101197", "149110177", "149110316", "149114859", "149120562", "149125019", "149130312", "149135448",
                                // 264        265          265          266          266          266          267          268          269          270
                                "149139896", "149144399", "149144689", "149151045", "149151082", "149151586", "149158110", "149162650", "149167969", "149169900",
                                // 270        271          271          271          272          273          274          275          276          277           270 duped; 271 tripled
                                "149173902", "149179465", "149181584", "149183142", "149187581", "149192382", "149197737", "149204135", "149210167", "149216662",

                                // Mods were apparently deleting many breads, these three had some info, but in the end 300 ended up being a regular bread
                                // 278        277          279
                                "149221697", "149222823", "149223061",

                                // 300        301          302          303          304          305          306          307          308          308           308 duped
                                "149224897", "149230437", "149236083", "149239745", "149247879", "149252842", "149260496", "149265504", "149270189", "149273153",
                                // 309        310          311          312          313          314          315          316          317          318
                                "149280969", "149286169", "149291994", "149297637", "149303874", "149309591", "149316146", "149322094", "149328998", "149333719",
                                // 319        320          321          322          323          324          325          326          327          328
                                "149338668", "149344411", "149348949", "149353656", "149359705", "149366100", "149374823", "149379962", "149385377", "149390757",
                                // 329        330          331          332          333          334          335          335          336          336           335, 336 duped
                                "149397178", "149404953", "149410834", "149417113", "149422627", "149429066", "149432843", "149437677", "149438602", "149441715",
                                // 337        338          339          340          341          342          343          344          345          346
                                "149449762", "149457308", "149463784", "149469572", "149474932", "149479854", "149485163", "149490717", "149496335", "149499440",
                                // 347        348          349          350          351          352          353          354          355          356
                                "149503768", "149509179", "149513473", "149516541", "149520389", "149524361", "149528861", "149530799", "149540364", "149545897",
                                // 357        358          359          360          361          362          363          364          365          366
                                "149552917", "149559971", "149565151", "149569949", "149575844", "149579431", "149584217", "149590900", "149597155", "149604054",
                                // 367        368          368          389          370          369          369-370      369          370          371           Various bread dupes/bad
                                "149610820", "149616383", "149617648", "149618718", "149623740", "149624717", "149631441", "149632338", "149638181", "149644727",
                                // 372        372          374          375          375          376          377          378          379          379           372, 375, 379 duped; 373 skipped
                                "149650266", "149659529", "149667557", "149674278", "149677391", "149682526", "149688744", "149697390", "149705681", "149713642",
                                // 380        380          381          381          383          384          385          386          387          387           380, 381, 387 duped; 382 skipped
                                "149719535", "149719579", "149726981", "149732367", "149741152", "149746448", "149753255", "149758825", "149765649", "149769522",
                                // 388        389          390          391          392          393          394          395          396          396           396 duped
                                "149770865", "149776645", "149781040", "149784795", "149788876", "149795051", "149799690", "149805519", "149812256", "149815107",
                                // 397        398          399          400          401          402          402          403          404          888           402 duped; 888 diversion?
                                "149819250", "149825225", "149836378", "149841984", "149847173", "149854697", "149855201", "149863346", "149870154", "149874157",
                                // 405        406          407          408          408          409          410          411          412          413           408 duped
                                "149875607", "149882450", "149888310", "149892325", "149893357", "149899275", "149903952", "149908339", "149912050", "149915235",
                                // 414        415          416          417          418          418          419          420          421          420           418, 420 duped
                                "149917448", "149920858", "149925262", "149930460", "149937338", "149937786", "149945455", "149953313", "149968456", "149968632",
                                // 421        423          424          424          425          425          426          427          427          428           424, 425, 427 duped
                                "149979088", "149989114", "149995879", "149998200", "150008526", "150016594", "150021146", "150022020", "150025958", "150032231",
                                // 429        430          432          433          434          435          436          437          438          438           431 skipped; 438 duped
                                "150036202", "150041909", "150059257", "150069297", "150077950", "150085746", "150095769", "150106848", "150116052", "150116276",
                                // 439        439          439          440          440          440          441          442          443          444           439, 440 tripped
                                "150125147", "150127368", "150129447", "150140038", "150145099", "150146588", "150147501", "150153890", "150160388", "150166775",
                                // 445        445          446          447          448          441          442          451          452          453           445 duped; 441, 442 mislabeled
                                "150171127", "150173597", "150176481", "150182567", "150192737", "150208420", "150216841", "150225180", "150230435", "150236616",
                                // 453        453          443          455          456          444          456          445          457          458           453 tripped; 443, 444, 445 mislabed; 456 duped
                                "150238907", "150240108", "150241247", "150246847", "150251292", "150256297", "150262301", "150263755", "150268748", "150273847",
                                // 459        460          461          462          463          463          464          465          466          467           463 duped
                                "150279998", "150286507", "150293105", "150299954", "150306802", "150309482", "150313839", "150321138", "150327187", "150332643",
                                // 468        469          470          471          472          473          474          475          476          477
                                "150338091", "150345294", "150353313", "150361794", "150369973", "150378085", "150386940", "150392746", "150400719", "150404223",
                                // 478        479          479          481          482          483          484          485          486          488           479 duped; 480, 487 skipped
                                "150410576", "150414788", "150419256", "150423953", "150428011", "150434009", "150438888", "150441779", "150446288", "150453386",
                                // 489        490          491          492          493          494          494          495          496          496           494, 496 duped
                                "150463111", "150468844", "150475707", "150481862", "150487756", "150492220", "150492436", "150500095", "150503830", "150506612",
                                // 497        499          498          498          499          499          500          501          501          502           498, 501 duped; 499 tripped
                                "150511300", "150519800", "150520974", "150521262", "150524397", "150526215", "150528566", "150530057", "150539844", "150543934",
                                // 502        503          504          504          505          507          505          508          506          509           504, 505 duped
                                "150546958", "150555010", "150561225", "150561611", "150565407", "150574556", "150578229", "150580134", "150584476", "150587155",
                                // 510        511          512          513          514          515          517          516          517          518           517 duped
                                "150594543", "150603013", "150609740", "150616639", "150623890", "150629843", "150633006", "150636004", "150643916", "150651354",
                                // 519        520          521          522          523          524          525          526          527          528
                                "150661430", "150666541", "150673355", "150678769", "150683692", "150688096", "150693391", "150698668", "150703328", "150709868",
                                // 529        530          531          532          533          534          535          536          537          538
                                "150716981", "150725005", "150732940", "150739124", "150744654", "150751001", "150757709", "150765366", "150771304", "150778757",
                                // 539        540          541          542          543          544          544          545          546          547           544 duped
                                "150787122", "150792931", "150798916", "150804610", "150809019", "150809759", "150813711", "150817715", "150820799", "150821765",
                                // 547        548          549          550          551          552          553          554          555          556           547 duped
                                "150824765", "150827069", "150829703", "150833955", "150837837", "150840805", "150848984", "150854913", "150862471", "150869511",
                                // 557        558          558          559          560          560          561          562          562          563           558, 560, 562 duped
                                "150873775", "150880490", "150881089", "150886344", "150895282", "150904965", "150911869", "150917659", "150918177", "150920828",
                                // 566        567          568          569          570          571          572          573          573          574           573 duped
                                "150925738", "150929268", "150933860", "150939016", "150962396", "150968272", "150972908", "150979025", "150980187", "150983475",
                                // 575        576          577          578          580          580          581          582          581          582           579 skipped; 580, 581, 582 duped
                                "150990673", "150997726", "151014520", "151024900", "151030336", "151050031", "151064404", "151069063", "151078419", "151090259",
                                // 584        588          589          590          591          592          592          595          596          600           TODO: verify these breads
                                "151127239", "151172711", "151177303", "151184006", "151205688", "151218007", "151224729", "151328253", "151351564", "151382096",
                                // 601        610          611                                                                                                      TODO: there are more after 611?
                                "151393371", "151530308", "151549034",

                                // Random thread with some posts from Q's trip code (are these verified by Q?)
                                "150864944"
                        ),
                        qtrips = listOf("!ITPb.qbhqo"),
                        qanonPosts = listOf(
                            "147023341", "147012719", "147104628", "147106598", "147109593", "147166292", "147167304",
                            "147169329", "147170576", "147173287", "147175452", "147181191", "147181801", "147433975",
                            "147434025", "147437247", "147440171", "147441378", "147443190", "147444335", "147444934",
                            "147445681", "147446992", "147448408", "147449010", "147449624", "147450817", "147451052",
                            "147452214", "147453147", "147454188", "147454631", "147455196", "147567888", "147567928",
                            "147581302", "147581516", "147586045", "147588085", "147588421", "147590619", "147591125",
                            "147591663", "147592019", "147632662", "147634822", "147636035", "147640127", "147641320",
                            "147642680", "147643257", "147645024", "147646189", "147646606", "147647154", "147661217",
                            "147661243", "147661332", "147664082", "147679416", "147680054", "147680749", "147681912",
                            "147683156", "147687684", "147689362", "147816901", "147817468", "147819733", "147975558",
                            "147979863", "147981354", "147986661", "147987614", "148016618", "148016670", "148016731",
                            "148016769", "148016876", "148019575", "148019905", "148020085", "148020278", "148021501",
                            "148022145", "148022342", "148023976", "148025825", "148027165", "148029633", "148029962",
                            "148031295", "148032210", "148032910", "148033178", "148033932", "148139234", "148139484",
                            "148143472", "148143562", "148148004", "148149435", "148152047", "148154137", "148154941",
                            "148155343", "148155609", "148156129", "148156632", "148156937", "148183670", "148185083",
                            "148185905", "148186256", "148189295", "148286961", "148287184", "148287236", "148287326",
                            "148287396", "148287473", "148287529", "148289594", "148452545", "148453749", "148455482",
                            "148457032", "150170117", "150170181", "150171298"
                        ),
                        qgraphics = listOf(
                            Pair("147023341", listOf(                                                                              "149083850"                          )),
                            Pair("147012719", listOf(                                                                              "149083850"                          )),
                            Pair("147104628", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("147106598", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("147109593", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("147166292", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147167304", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147169329", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147170576", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147173287", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147175452", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147181191", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147181801", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("147433975", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147434025", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147437247", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147440171", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147441378", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147443190", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147444335", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147444934", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147445681", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147446992", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147448408", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147449010", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147449624", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147450817", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147451052", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147452214", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147453147", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147454188", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147454631", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147455196", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147567888", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147567928", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147581302", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147581516", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147586045", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147588085", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147588421", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147590619", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147591125", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147591663", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147592019", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147632662", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147634822", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147636035", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147640127", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147641320", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147642680", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147643257", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147645024", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147646189", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147646606", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147647154", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147661217", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147661243", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147661332", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147664082", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147679416", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147680054", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147680749", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147681912", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147683156", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147687684", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147689362", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147816901", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147817468", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147819733", listOf("148016876", "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147975558", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147979863", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147981354", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("147986661", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("147987614", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148016618", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148016670", listOf(                                                                                                                   )),
                            Pair("148016731", listOf(                                                                                                                   )),
                            Pair("148016769", listOf(                                                                                                                   )),
                            Pair("148016876", listOf(                                                                                                                   )),
                            Pair("148019575", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148019905", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148020085", listOf(                                                                                                                   )),
                            Pair("148020278", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148021501", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148022145", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148022342", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148023976", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148025825", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148027165", listOf(             "148028820", "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148029633", listOf(                          "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148029962", listOf(                          "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148031295", listOf(                          "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148032210", listOf(                          "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148032910", listOf(                          "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148033178", listOf(                          "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148033932", listOf(                          "148136656", "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148139234", listOf(                                       "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148139484", listOf(                                       "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148143472", listOf(                                       "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148143562", listOf(                                       "148147343", "148779656", "148872136", "149083850"                          )),
                            Pair("148148004", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148149435", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148152047", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148154137", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148154941", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148155343", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148155609", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148156129", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148156632", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148156937", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148183670", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148185083", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148185905", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148186256", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148189295", listOf(                                                                                                                   )),
                            Pair("148286961", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148287184", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148287236", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148287326", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148287396", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148287473", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148287529", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148289594", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148452545", listOf(                                                    "148779656"                                                    )),
                            Pair("148453749", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148455482", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148457032", listOf(                                                    "148779656", "148872136", "149083850"                          )),
                            Pair("148779656", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148781546", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148782302", listOf(                                                                 "148872136", "149083850"                          )),
                            Pair("148871375", listOf(                                                                              "149083850"                          )),
                            Pair("148872500", listOf(                                                                              "149083850"                          )),
                            Pair("149063235", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149063271", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149063400", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149063442", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149063509", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149063549", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149063582", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149063644", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149065482", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149122955", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149124567", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149140639", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149151705", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149152902", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149157229", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149160361", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149262582", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149401052", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149402892", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149467638", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149467690", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149490950", listOf(                                                                                           "150171513", "150171863")),
                            Pair("149921023", listOf(                                                                                           "150171513", "150171863")),
                            Pair("150166904", listOf(                                                                                           "150171513", "150171863")),
                            Pair("150166936", listOf(                                                                                           "150171513", "150171863")),
                            Pair("150171298", listOf(                                                                                                        "150171863"))
                        )
                ))
        )
    }

    init {
        // Collect unique threads from qcodefag and qanonmap
        /*
        QCodeFagMirror(mirrorDirectory, "pol", Source.FourChan, "pol4chanPosts", startTime, stopTime).MirrorSearch(SearchParameters(content = Regex(".*"), onlyQT = false))
                .forEach { post ->
                    if(!threads.contains((post as PostEvent).threadId)) {
                        threads.add(post.threadId)
                    }
                }
        QAnonMapMirror(mirrorDirectory,"pol", Source.FourChan, "pol4chanPosts", startTime, stopTime).MirrorSearch(SearchParameters(content = Regex(".*"), onlyQT = false))
                .forEach { post ->
                    if(!threads.contains((post as PostEvent).threadId)) {
                        threads.add(post.threadId)
                    }
                }
                */
        threads.addAll(EXCEPTIONS["pol"]!!.orphanThreads)
    }

    override fun Mirror() {
        println(">> mirror: $this")
        updatedThreads.clear()
        if (MakeDirectory(mirrorRoot)) {
            val filesRoot = mirrorRoot + File.separator + "files"

            if (!MakeDirectory(boardRoot)) {
                return
            }
            if (!MakeDirectory(filesRoot)) {
                return
            }

            threads.sortedBy{ -it.toLong() }.forEach { thread ->
                val threadRoot = boardRoot + File.separator + thread
                if (MakeDirectory(threadRoot)) {
                    val threadURL = URL("https://archive.4plebs.org/_/api/chan/thread/?board=pol&num=$thread")
                    val threadFile = File(threadRoot + File.separator + "$thread.json")

                    // Update activity json if necessary
                    try {
                        if (threadFile.iterate(threadURL.readBytesDelayed())) {
                            println("    Updated thread $thread") // (${ZonedDateTime.ofInstant(Instant.ofEpochSecond(thread.time), ZONEID).format(DATEFORMATTER)})")
                            updatedThreads.add(thread)
                        }
                    } catch (e: FileNotFoundException) {
                        println("Unable to find thread for $board: $e")
                    } catch (e: IOException) {
                        println("Unable to download thread for $board: $e")
                    }
                }
            }
        }
    }

    override fun MirrorReferences() {
        println(">> mirror refs: $this")
        threads.sortedBy { -it.toLong() }.forEach { thread ->
            val threadRoot = boardRoot + File.separator + thread
            val threadFile = File(threadRoot + File.separator + "$thread.json")
            val threadUpdated = updatedThreads.contains(thread)

            // Check post files and references
            if(threadFile.exists()) {
                val listType = object : TypeToken<Map<String, FourChanThread>>() {}.type
                val threadMap : Map<String, FourChanThread> = Gson().fromJson(threadFile.readText(), listType)

                // Check thread files and references
                if(threadMap[thread]!!.op.media != null) {
                    MirrorFile(threadUpdated, threadMap[thread]!!.op.media!!)
                }
                //MirrorReferences(threadUpdated, boardRoot, thread.no, thread.no, listOf(thread.name, thread.com).joinToString("\n"))

                if(threadMap[thread]!!.posts != null) {
                    threadMap[thread]!!.posts!!.keys.forEachIndexed { index, postIndex ->
                        val post = threadMap[thread]!!.posts!![postIndex]!!
                        if (index == 0) {
                            println("  >> thread: $thread (${cleanHTMLText(post.comment ?: "")
                                    .lines().first()}): ${index + 1} / ${threads.size} (% ${Math.round(index.toFloat() / threads.size * 100)})")
                            if (threadUpdated) {
                            }
                        }

                        if (post.media != null) {
                            MirrorFile(threadUpdated, post.media!!)
                        }
                        //MirrorReferences(threadUpdated, boardRoot, thread.no, post.no, listOf(post.title, post.sub, post.com).joinToString("\n"))
                    }
                }
            } else {
                println("  >> thread: $thread: unable to find thread file: $threadFile")
            }
        }
    }

    fun MirrorFile(shouldUpdate: Boolean, media : FourChanPost.FourChanPostMedia) {
        // Don't mirror banned files
        if(media.banned == "1") {
            return
        }
        val thumbURL = URL(media.thumb_link)
        val fileURL = URL(media.media_link)
        val firstNest = media.media.substring(0, 4)
        val secondNest = media.media.substring(4, 6)
        val folder = media.media.substring(0, media.media.lastIndexOf('.'))
        val thumbFile = File(filesRoot + File.separator + firstNest + File.separator + secondNest + File.separator + folder + File.separator + media.preview_orig)
        val fileFile = File(filesRoot + File.separator + firstNest + File.separator + secondNest + File.separator + folder + File.separator + media.media_filename_processed)

        try {
            if (MakeDirectory(thumbFile.parentFile.absolutePath)) {
                // TODO: verify checksums
                if (!thumbFile.exists() || shouldUpdate) {
                    if (thumbFile.iterate(thumbURL.readBytesDelayed())) {
                        println("      Updated file: ${thumbFile.name}")
                    }
                }
            }
            if (MakeDirectory(fileFile.parentFile.absolutePath)) {
                // TODO: verify checksums
                if(!fileFile.exists() || shouldUpdate) {
                    if (fileFile.iterate(fileURL.readBytesDelayed())) {
                        println("      Updated file: ${fileFile.name}")
                    }
                }
            }
        } catch(e : FileNotFoundException) {
            println("    Unable to find file : `$fileURL'\n$e")
        } catch(e : IOException) {
            println("    Unable to retrieve file: `$fileURL'\n$e")
        }

    }

    override fun MirrorSearch(params: SearchParameters): List<Event> {
        val eventList: MutableMap<String, Event> = mutableMapOf()
        val boardRoot = mirrorRoot + File.separator + "boards" + File.separator + board

        println(">> search: $this")

        threads.sortedBy { it.toLong() }.forEachIndexed { index, thread ->
            val threadRoot = boardRoot + File.separator + thread
            val threadUpdated = updatedThreads.contains(thread)

            File(threadRoot).listFiles().sortedBy { -it.lastModified() }.forEach { threadFile ->
                if (threadFile.name.startsWith(thread) && threadFile.extension.startsWith("json")) {
                    // Check post files and references
                    try {
                        val error: Map<String, String> = Gson().fromJson(threadFile.readText(), object : TypeToken<Map<String, String>>() {}.type)
                        if (error.containsKey("error")) {
                            return@forEachIndexed
                        }
                    } catch (e: Exception) { /* all ok, not an error */
                    }
                    val listType = object : TypeToken<Map<String, FourChanThread>>() {}.type
                    val threadMap: Map<String, FourChanThread> = Gson().fromJson(threadFile.readText(), listType)

                    val threadPostEvent = PostEvent.fromFourChanPost("anonsw", source, board, threadFile.absolutePath, threadMap[thread]!!.op)
                    if (params.condition.Search(EXCEPTIONS[board]!!, threadPostEvent)) {
                        // Add to event list if it isn't already there
                        if (!eventList.containsKey(threadPostEvent.Link())) {
                            eventList[threadPostEvent.Link()] = threadPostEvent
                        }
                    }

                    if (threadMap[thread]!!.posts != null) {
                        threadMap[thread]!!.posts!!.keys.forEach {
                            val post = threadMap[thread]!!.posts!![it]!!

                            val postEvent = PostEvent.fromFourChanPost("anonsw", source, board, threadFile.absolutePath, post)
                            if (params.condition.Search(EXCEPTIONS[board]!!, postEvent)) {
                                // Add to event list if it isn't already there
                                if (!eventList.containsKey(postEvent.ID())) {
                                    eventList[postEvent.ID()] = postEvent
                                }
                            }
                        }
                    }
                }
            }

            val pct = Math.round(index.toFloat() / threads.size * 1000)
            if (pct.rem(100) == 0) {
                println("  >> thread: $thread: ${index + 1} / ${threads.size} (% ${Math.round(index.toFloat() / threads.size * 100)})")
            }
        }

        println("  >> Found ${eventList.size} events.")

        return eventList.values.toList()
    }
}
